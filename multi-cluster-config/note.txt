                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                 Git Repository               â”‚
                           â”‚ (App manifests, Helm charts, ArgoCD config)  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â–²
                                              â”‚ GitOps Sync
                                              â”‚
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚         Bastion EC2       â”‚
                                â”‚ (CLI: aws, eksctl, kubectlâ”‚
                                â”‚        argocd, helm)      â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚                                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   EKS Cluster 1      â”‚       â”‚    EKS Cluster 2       â”‚       â”‚    EKS Cluster 3       â”‚
   â”‚  (us-east-1a)        â”‚       â”‚   (us-east-1b)         â”‚       â”‚   (us-east-1c)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                â”‚                                â”‚
             â”‚                                â”‚                                â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ArgoCD (Core)â”‚                â”‚  ArgoCD (Agent)â”‚               â”‚  ArgoCD (Agent) â”‚
      â”‚    Server    â”‚                â”‚ (Optional Sync)â”‚               â”‚ (Optional Sync) â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


A- dÃ©ploiement de la VM BASTION
https://github.com/OlivierKouokam/aws-tf-stack/terraform-tf

B- dÃ©ploiement des clusters depuis la VM BASTION

ðŸ› ï¸ Script adaptÃ© pour Bastion EC2 GitOps Multi-cluster

#!/bin/bash

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. AWS Credentials & Region Setup (Temporary, use IAM role ideally)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export AWS_ACCESS_KEY_ID=XXX**************XXX
export AWS_SECRET_ACCESS_KEY=YYY**********************************YYY
export AWS_DEFAULT_REGION=us-east-1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Install Required Tools (eksctl, aws-cli, kubectl, argocd cli)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sudo apt update
sudo apt install -y unzip curl bash-completion

# Install eksctl
curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin/

# Install AWS CLI v2
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
aws --version

# Ou bien
# sudo snap install aws-cli --classic
# aws --version

# Install kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Optional: Install ArgoCD CLI
curl -sSL -o argocd "https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64"
chmod +x argocd
sudo mv argocd /usr/local/bin/

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Create 3 EKS Clusters (devops, staging, prod for example)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

for cluster in cluster-devops cluster-staging cluster-prod; do
  eksctl create cluster \
    --name $cluster \
    --region us-east-1 \
    --version 1.34 \
    --managed \
    --nodegroup-name ng-workers \
    --node-type t3.medium \
    --nodes 2 \
    --nodes-min 1 \
    --nodes-max 5 \
    --node-volume-size 50 \
    --ssh-access \
    --ssh-public-key devops-terraform \
    --with-oidc \
    --asg-access \
    --tags "env=devops,team=gitops"
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Configure Kubeconfig for Multi-Cluster Context Switching
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mkdir -p $HOME/.kube

for cluster in cluster-devops cluster-staging cluster-prod; do
  eksctl utils write-kubeconfig \
    --cluster $cluster \
    --kubeconfig=$HOME/.kube/config-$cluster
done

# Merge kubeconfigs manually or switch using KUBECONFIG env
## echo 'export KUBECONFIG=$HOME/.kube/config-cluster-devops:$HOME/.kube/config-cluster-staging:$HOME/.kube/config-cluster-prod' >> ~/.bashrc
## export KUBECONFIG=$HOME/.kube/config-cluster-devops:$HOME/.kube/config-cluster-staging:$HOME/.kube/config-cluster-prod
## alias kdevops="KUBECONFIG=~/.kube/config-cluster-devops kubectl"
## alias kstaging="KUBECONFIG=~/.kube/config-cluster-staging kubectl"
## alias kprod="KUBECONFIG=~/.kube/config-cluster-prod kubectl"



# Rename contexts
echo
echo "list all contexts"
echo
kubectl config get-contexts
echo
echo "get aws identity"
echo
aws sts get-caller-identity
echo
echo "Rename every context"
echo
kubectl config rename-context arn:aws:eks:us-east-1:<account_id>:cluster/cluster-devops devops
kubectl config rename-context arn:aws:eks:us-east-1:<account_id>:cluster/cluster-staging staging
kubectl config rename-context arn:aws:eks:us-east-1:<account_id>:cluster/cluster-prod prod


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Enable kubectl autocompletion
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo 'source <(kubectl completion bash)' >> ${HOME}/.bashrc
source ${HOME}/.bashrc


B-1 VÃ©rifier que eksctl a bien configurÃ© le fichier config avec tous les contexts

kubectl config view


B-2 Installer argocd dans le cluster-devops

ðŸš€ Bootstrap ArgoCD & Multi-cluster GitOps Setup

#!/bin/bash

set -e

# Variables cluster
CENTRAL_CLUSTER="cluster-devops"
REMOTE_CLUSTERS=("cluster-staging" "cluster-prod")

# Kubeconfig paths
## export KUBECONFIG=$HOME/.kube/config-$CENTRAL_CLUSTER
kubectl config get-contexts
kubectl config use-context devops

# 1. Installer ArgoCD sur le cluster central

echo "Installing ArgoCD on $CENTRAL_CLUSTER ..."
kubectl create namespace argocd || true
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

echo "Waiting for ArgoCD server deployment to be ready..."
kubectl -n argocd rollout status deployment argocd-server

# 2. Exposer le serveur ArgoCD (option simple via port-forward, ou LoadBalancer)

# Option 1: Port-forward (pour test/dev)
## echo "Starting port-forward for ArgoCD server (local port 8080)..."
## kubectl -n argocd port-forward svc/argocd-server 8080:443 & PORT_FORWARD_PID=$!
## sleep 5 # wait a moment for port-forward to be established

# Option 2: Patch argocd service to NodePort or LoadBalancer
			Or create argocd-server-lb LoadBalancer service



# 3. Login ArgoCD CLI (password = admin initial password is in a secret)

ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 --decode)

kubectl -n argocd get svc argocd-server-lb -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'

argocd login <argocd-server-lb svc url:port> --username admin --password $ARGOCD_PASSWORD --insecure

# 4. Ajouter les clusters distants Ã  ArgoCD

###  for cluster in "${REMOTE_CLUSTERS[@]}"; do
###    echo "Adding cluster $cluster to ArgoCD..."
###  
###  export KUBECONFIG=$HOME/.kube/config-$cluster
###  
###    # On rÃ©cupÃ¨re le contexte kubectl
###    CONTEXT_NAME=$(kubectl config current-context)
###  
###    # Ajouter le cluster distant dans ArgoCD
###    argocd cluster add $CONTEXT_NAME --yes
###  done

/*
for cluster in "${REMOTE_CLUSTERS[@]}"; do
  echo "Adding cluster $cluster to ArgoCD..."

  # On rÃ©cupÃ¨re le contexte kubectl
  CONTEXT_NAME=$(kubectl config current-context)

  # Ajouter le cluster distant dans ArgoCD
  argocd cluster add $CONTEXT_NAME --yes
done
*/


echo "Bootstrap ArgoCD multi-cluster terminÃ© !"

# 5. Suggestion: configure argocd CLI autocompletion
echo 'source <(argocd completion bash)' >> ~/.bashrc
source ~/.bashrc


3-c ajouter les clusters avec la commande "argocd cluster add"
  
	for context in devops staging prod; do
	  echo "âž• Ajout du cluster: $context"
	  argocd cluster add "$context" --name "$context"
	done
  
  argocd cluster list

kubectl get sa -n argocd
kubectl get clusterrolebinding -o wide | grep argocd
kubectl get clusterrole argocd-application-controller -o yaml
	
https://github.com/OlivierKouokam/argocd-repo.git
https://github.com/kodekloudhub/example-voting-app/tree/master/k8s-specifications
